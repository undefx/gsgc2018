const audio=(()=>{const d=new AudioContext,f=0.05;return{playNote:p=>{const t=d.currentTime,D=d.createOscillator();D.frequency.setValueAtTime(p,t);const E=d.createGain();E.gain.setValueAtTime(f,t),D.connect(E),E.connect(d.destination),D.start(t),D.stop(t+0.25)},playDrum:p=>{const t=d.currentTime,u=t+0.25,D=d.createOscillator();D.frequency.setValueAtTime(p,t),D.frequency.exponentialRampToValueAtTime(f/100,u);const E=d.createGain();E.gain.setValueAtTime(f,t),E.gain.exponentialRampToValueAtTime(f/100,u),D.connect(E),E.connect(d.destination),D.start(t),D.stop(u)},playTheme:()=>{let p=0;for(let t=0;4>t;t++){for(let u=0;3>u;u++)setTimeout(()=>audio.playDrum(220),p+1200*u/3);p+=1200;for(let u=0.25;2.25>u;u++)setTimeout(()=>audio.playDrum(220),p+800*u/3);p+=800;for(let u=0;16>u;u++)setTimeout(()=>audio.playDrum(220),p+2e3*u/16);p+=2e3}}}})();const setup=()=>{const d=0.0015,f={w:'forward',a:'left',s:'backward',d:'right',' ':'jumping'},t=document.getElementsByTagName('canvas')[0],u=(K=>{const M=K.getContext('webgl',{alpha:!1,antialias:!1});return M.enable(M.CULL_FACE),M.frontFace(M.CCW),M.cullFace(M.BACK),M})(t),D=ut(u,paletteTexture()),E={},F=ut(u,img_text),G='abcdefghijklmnopqrstuvwxyz0123456789.,!?-+:/@ ';for(let K=0;K<G.length;K++){const L=newQuad(u,D,F,K,G.length);E[G[K]]=L}const H=(K,L,M)=>{for(let N=0;N<L.length;N++)E[L[N]](K,M),M=mm(M,tr(2,0,0))},J=newGame();J.s.renderFuncGenArgs=[t,u,J,D,H,(K,L)=>{const M=L.length;return renderToTexture(K,192,256,()=>{let N=identity();N=mm(N,tr(-0.5,-0.5,0)),N=mm(N,scale(1/2,1/2,1)),N=mm(N,scale(1/M,-1/M,1)),N=mm(N,tr(1,-1,0));for(let O=0;O<L.length;O++)H(K,L[O],N),N=mm(N,tr(0,-2,0))})}],J.s.renderFuncGen=getGameRenderer,J.goToLevel(1,!1,null),t.addEventListener('keydown',K=>{f.hasOwnProperty(K.key)&&(J.s.input[f[K.key]]=!0)}),t.addEventListener('keyup',K=>{f.hasOwnProperty(K.key)&&(J.s.input[f[K.key]]=!1)}),t.addEventListener('click',()=>{J.s.input.pointerLocked||t.requestPointerLock()}),t.addEventListener('mousedown',()=>{J.s.input.pointerLocked&&J.s.sendOrb()}),t.addEventListener('mousemove',K=>{J.s.input.pointerLocked&&(J.s.player.direction+=K.movementX*d,J.s.player.altitude-=K.movementY*d,J.s.player.altitude=Math.min(J.s.player.altitude,+Math.PI/2),J.s.player.altitude=Math.max(J.s.player.altitude,-Math.PI/2))}),document.addEventListener('pointerlockchange',()=>{const L=document.pointerLockElement===t;J.s.levelStatus=L?null:'click to play',!J.s.input.pointerLocked&&L?(J.s.input.pointerLocked=document.pointerLockElement===t,J.s.input.pointerLocked&&audio.playNote(440)):!L&&(J.s.input.pointerLocked=!1,audio.playNote(415))}),setInterval(audio.playTheme,6e4),J.s.levelStatus='click to play',requestAnimationFrame(J.s.renderFunc)},getGameRenderer=(d,f,p,t,u,D)=>{const E=''+p.s.level,F=D(f,['+              +','','level:          '.slice(0,16-E.length)+E,'','move:    w/a/s/d','','jump:      space','','shoot:     click','','','   objective:',' get out alive','','   good luck!','+              +']),G=D(f,['+   +',' got ',' out ','alive','+   +']),H=newProgram(f,'block'),I=ka=>({program:H,palette:t,texture:ka,vertices:[],texCoords:[],render:null}),J=newProgram(f,'powerup'),L=ut(f,randomTexture(8,0,0.2,0.7)),M=I(L),N=ut(f,solidTexture(0.8,0.4,0.1)),O=I(N);addBlockToMesh(O,-0.5,-0.5,-0.5),O.render=newMeshRenderer(f,O);const P=createEmitter(f,t),Q=ut(f,solidTexture(0.9,0.2,0.2));for(var R=I(Q),S=[],T=0;T<p.s.baddieCount;T++)S.push(newBaddie(f,R,p.s.baddieSpeed));const U=ut(f,solidTexture(0.5,0.5,0.7)),V=ut(f,solidTexture(0.7,0,0)),W=newQuad(f,t,U,0,1),X=newQuad(f,t,V,0,1),$=ut(f,solidTexture(0.5,0.5,0.5)),_=newQuad(f,t,N,0,1),aa=newQuad(f,t,$,0,1),ba=ut(f,solidTexture(0.8,0.8,0.8)),da=newQuad(f,t,ba,0,1),ea={1:I(ut(f,randomTexture(16,0.7,0,0))),2:I(ut(f,randomTexture(16,0,0.7,0))),3:I(ut(f,randomTexture(8,0.5,0.5,0.3))),4:I(ut(f,randomTexture(8,0.7,0.7,0.7))),5:I(F),10:I(G),ramps:M},fa=solidTextureStack([0.8,0.4,0.1],[0.5,0.5,0.7],[1,1,1]),ga=ut(f,fa),ha=(ka=>({program:J,palette:t,texture:ka,vertices:[],texCoords:[],positions:[],types:[],render:null}))(ga);for(let ka=0;ka<m.b.length;ka++)for(let la=0;la<m.b[0].length;la++)for(let na,ma=0;ma<m.b[0][0].length;ma++){na=m.b[ka][la][ma];const oa=6<=na&&9>=na;if(ea.hasOwnProperty(na)||oa)if(oa){const qa=na-6;addRampToMesh(ea.ramps,qa,ma,ka,la)}else addBlockToMesh(ea[na],ma,ka,la);const pa=m.blockInfo[ka][la][ma].powerup;addPowerupToMesh(ha,ma,ka,la,pa)}Object.getOwnPropertyNames(ea).forEach(ka=>{ea[ka].render=newMeshRenderer(f,ea[ka])}),ha.renderer=newPowerupRenderer(f,ha),p.setPowerupRenderer(ha.renderer);let ia=0;return ka=>{requestAnimationFrame(p.s.renderFunc),ia=ka,null==p.s.levelStatus&&p.update(ka),null==p.s.levelStatus&&S.forEach(ra=>{ra.update(ka,p.s.player.l)}),S.forEach(ra=>{const ta=ra.hitBox;p.s.orbs.forEach(ua=>{const va=ra.l.x-ua.position.x,wa=ra.l.y-ua.position.y,xa=ra.l.z-ua.position.z;Math.abs(va)<ta&&Math.abs(wa)<ta&&Math.abs(xa)<ta&&(ua.explode(p.s.emitterSpawns),ra.health-=1,0>=ra.health?ra.explode(p.s.emitterSpawns):audio.playNote(392))})}),S.forEach(ra=>{if(!(0>=ra.health)){const ta=ra.hitBox+p.s.player.hitBox,ua=ra.l.x-p.s.player.l.x,va=ra.l.y-p.s.player.l.y,wa=ra.l.z-p.s.player.l.z;Math.abs(ua)<ta&&Math.abs(va)<ta&&Math.abs(wa)<ta&&(p.doDamage(1),ra.explode(p.s.emitterSpawns))}});for(let ra=0;ra<S.length;ra++)0>=S[ra].health&&S.splice(ra--,1);f.viewport(0,0,f.drawingBufferWidth,f.drawingBufferHeight),f.clearColor(1,1,1,1),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT),f.enable(f.DEPTH_TEST);const la=d.clientWidth/d.clientHeight,ma=1.2*Math.PI/2;let na=identity();na=mm(na,perspective(la,ma)),na=mm(na,tr(0,-0.01,-1)),na=mm(na,rotate.x(-p.s.player.altitude)),na=mm(na,rotate.y(-p.s.player.direction));const oa=tr(-p.s.player.l.x,-p.s.player.l.y,-p.s.player.l.z);if(na=mm(na,oa),Object.getOwnPropertyNames(ea).forEach(ra=>{0<ea[ra].vertices.length&&ea[ra].render(na)}),!1!=ha.renderer.stale){const ra=ha.renderer.stale;ha.renderer.stale=!1,f.bindBuffer(f.ARRAY_BUFFER,ha.renderer.typeBufferId);const ta=ha.renderer.typeData.slice(ra,ra+6);f.bufferSubData(f.ARRAY_BUFFER,4*ra,new Float32Array(ta))}const pa=p.s.player.l;ha.renderer.render(na,1e-3*ka,pa.x,pa.y,pa.z),S.forEach(ra=>{let ta;ta=mm(na,tr(ra.l.x,ra.l.y,ra.l.z)),ta=mm(ta,scale(0.5,0.5,0.5)),ra.render(ta)}),p.s.orbs.forEach(ra=>{let ta=mm(na,tr(ra.position.x,ra.position.y,ra.position.z));ta=mm(ta,scale(0.05,0.05,0.05)),O.render(ta)}),0<p.s.emitterSpawns.length&&(p.s.emitterSpawns.forEach(ra=>{p.s.emitters.push(spawnEmitter(P,...ra))}),p.s.emitterSpawns=[]),p.s.emitters.forEach(ra=>{ra.render(na,ka,p)}),f.disable(f.DEPTH_TEST),na=identity(),na=mm(na,scale(1/2,1/20,1)),na=mm(na,tr(0,-19,0)),X(f,na);let qa=p.s.player.health/p.s.limits.health;na=identity(),na=mm(na,tr(-1/2,0,0)),na=mm(na,scale(qa/2,1/20,1)),na=mm(na,tr(1,-19,0)),W(f,na),na=identity(),na=mm(na,scale(1/2,1/20,1)),na=mm(na,tr(0,-17,0)),aa(f,na),qa=p.s.player.ammo/p.s.limits.ammo,na=identity(),na=mm(na,tr(-1/2,0,0)),na=mm(na,scale(qa/2,1/20,1)),na=mm(na,tr(1,-17,0)),_(f,na);for(let ra=0;5>ra;ra++)na=identity(),na=mm(na,tr(-1/360,0,0)),na=mm(na,rotate.z(2*(ra*Math.PI)/3)),na=mm(na,scale(1/360,1/100,1)),na=mm(na,tr(0,2.2,0)),da(f,na);if(null!=p.s.levelStatus){const ra=p.s.levelStatus.length;na=identity(),na=mm(na,tr(-ra/30,0,0)),na=mm(na,scale(12/360,48/400,1)),na=mm(na,tr(1,0,0)),u(f,p.s.levelStatus,na)}}};const getCollisions=(d,f,p,t)=>{let u=0,D=0,E=0,F=0,G=0;0<p&&0!=d[f][p-1][t]&&8!=d[f][p-1][t]&&(E=1),p<d[0].length-1&&0!=d[f][p+1][t]&&6!=d[f][p+1][t]&&(F=1),0<t&&0!=d[f][p][t-1]&&7!=d[f][p][t-1]&&(u=1),t<d[0][0].length-1&&0!=d[f][p][t+1]&&9!=d[f][p][t+1]&&(D=1);const H=0==d[f][p][t],I=0==d[f-1][p][t];return 0<f&&!(H&&I)&&([6,7,8,9].includes(d[f][p][t])?G=d[f][p][t]:[6,7,8,9].includes(d[f-1][p][t])?G=-d[f-1][p][t]:G=1),[E,F,u,D,G]},getPosition=(d,f,p)=>{return 0.25>d?0.25*f+(1-f)*d:0.75<=d?0.75*p+(1-p)*d:d},getPositionY=(d,f,p,t)=>{let u=6==t?f+0.5:-6==t?f-0.5:8==t?1-f+0.5:-8==t?1-f-0.5:7==t?1-d+0.5:-7==t?1-d-0.5:9==t?d+0.5:-9==t?d-0.5:0==t?-1:0.5;const D=p>u;return[Math.max(p,u),D]},getCoords=d=>[d.x,d.y,d.z],getIntCoords=d=>[Math.floor(d.x),Math.floor(d.y),Math.floor(d.z)],randomFloor=()=>{return 1.5+2*Math.round(Math.random()*((m.b.length-1)/2-1))},newGame=()=>{const d={levelStatus:null,renderFuncGenArgs:null,renderFuncGen:null,renderFunc:null,level:1,baddieCount:2,baddieSpeed:.9,limits:{health:3,ammo:25},player:{l:{x:m.start_position.x,y:m.start_position.y,z:m.start_position.z},direction:m.start_direction,altitude:0,fallSpeed:0,health:3,ammo:15,hitBox:0.5},input:{forward:!1,backward:!1,left:!1,right:!1,pointerLocked:!1,jumping:!1},orbs:[],emitterSpawns:[],emitters:[]};let f=null;d.sendOrb=()=>{if(0!=d.player.ammo){d.player.ammo--;const I=0.25,J=Math.sin(d.player.direction),K=Math.cos(d.player.direction),L=Math.sin(d.player.altitude),M=Math.cos(d.player.altitude),N={active:!0,position:{x:d.player.l.x,y:d.player.l.y,z:d.player.l.z},velocity:{x:I*J*M,y:I*L,z:I*K*M}};N.explode=O=>{audio.playDrum(250),N.active=!1;const[P,Q,R]=getCoords(N.position);O.push([P,Q,R,1])},audio.playDrum(500),d.orbs.push(N)}};const p=(I,J,K)=>{d.levelStatus=K;const L=()=>{d.baddieCount+=3==I%5?1:0,d.baddieSpeed+=.02,m.height+=1==I%4?1:0,m.width+=3==I%4?1:0,m.layers+=2==I%3?1:0,m.rampsPerLayer=Math.max(2,Math.floor(m.height/6)),m.init(I),d.levelStatus=null,d.level=I,d.player.l.x=m.start_position.x,d.player.l.y=m.start_position.y,d.player.l.z=m.start_position.z,d.player.direction=m.start_direction,d.player.altitude=0,d.player.fallSpeed=0,d.player.health=3,d.player.ammo=15,d.renderFunc=d.renderFuncGen(...d.renderFuncGenArgs)};J?setTimeout(L,2e3):L()},t=[[5,4,3],[6,0,2],[7,0,1]],u=Math.PI/4,D=0.16;let G=0;return{s:d,update:I=>{const J=Math.min(I-G,160)/1e3;G=I;let K=0,L=0;const M=J*2,N=[1+d.input.forward-d.input.backward,1+d.input.right-d.input.left];if(1!=N[0]||1!=N[1]){const T=t[N[0]][N[1]]*u,U=d.player.direction+T;L+=M*Math.cos(U),K+=M*Math.sin(U)}d.input.jumping&&0==d.player.fallSpeed&&(d.player.fallSpeed-=0.04);let O=-d.player.fallSpeed;if(0!=K||0!=O||0!=L){const[T,U,V]=getCoords(d.player.l),[W,X,Y]=getIntCoords(d.player.l),$=getCollisions(m.b,X,Y,W),aa=getPosition(T-W+K,$[2],$[3]);d.player.l.x=W+aa;const da=getPosition(V-Y+L,$[0],$[1]);d.player.l.z=Y+da;const[fa,ga]=getPositionY(aa,da,U-X+O,$[4]);d.player.l.y=X+fa,ga?d.player.fallSpeed+=J*D:d.player.fallSpeed=0}const[P,Q,R]=getIntCoords(d.player.l),S=m.blockInfo[Q][R][P].powerup;if(S!=pt.none){let T=!0;S==pt.ammo?d.player.ammo=Math.min(d.player.ammo+5,d.limits.ammo):S==pt.health?d.player.health=Math.min(d.player.health+1,d.limits.health):S==pt.exit&&(audio.playNote(440),setTimeout(()=>audio.playNote(554),200),setTimeout(()=>audio.playNote(659),400),p(d.level+1,!0,'next level'),T=!1),m.blockInfo[Q][R][P].powerup=pt.none;let U=m.blockInfo[Q][R][P].attributeBufferIndex;U*=6;for(let V=0;6>V;V++)f.typeData[U+V]=pt.none;f.stale=U,T&&audio.playNote(659)}d.orbs.forEach(T=>{T.position.x+=T.velocity.x,T.position.y+=T.velocity.y,T.position.z+=T.velocity.z,T.velocity.y-=J*D;const U=Math.floor(T.position.x),V=Math.floor(T.position.y),W=Math.floor(T.position.z);0!=m.b[V][W][U]&&T.explode(d.emitterSpawns)}),d.emitters.forEach(T=>{T.s.age+=3*J});for(let T=0;T<d.orbs.length;T++)d.orbs[T].active||d.orbs.splice(T--,1);for(let T=0;T<d.emitters.length;T++)1<d.emitters[T].s.age&&d.emitters.splice(T--,1)},setPowerupRenderer:I=>{f=I},doDamage:I=>{d.player.health-=I,0>=d.player.health?(audio.playNote(440),setTimeout(()=>audio.playNote(370),200),setTimeout(()=>audio.playNote(349),400),p(d.level,!0,'try again')):audio.playNote(466)},goToLevel:p}},newBaddie=(d,f,p)=>{for(var t=randomFloor(),u=randomEmptyZX(t,0);1==Math.floor(t)&&(4>u[0]||4>u[0]);)u=randomEmptyZX(t,0);const D={l:{x:u[1],y:t,z:u[0]},hitTime:0,hitBox:0.25,health:3,speedMult:p};addBlockToMesh(f,-0.5,-0.5,-0.5),D.render=newMeshRenderer(d,f),D.findRamp=(F,G,H,I)=>{var J=bfs(F+I,G,H,null,null,[6,7,8,9],0>I);if(2==J.length)return J;var K=findRampFoot(J[0],J[1],J[2],I);return G==J[1]+K[0]&&H==J[2]+K[1]?(D.shortGoal[0]=-1*K[0],D.shortGoal[1]=-1*K[1],D.shortGoal[2]=G+3*D.shortGoal[0],D.shortGoal[3]=H+3*D.shortGoal[1],D.shortGoal[4]=D.l.y,D.shortGoal[5]=D.l.y+(0==I?2:-2),null):bfs(F,G,H,J[1]+K[0],J[2]+K[1],[],!1)},D.getGoal=(F,G,H,I,J)=>{var K=[0,0];return H==Math.floor(G.y)&&(K=bfs(H,I,J,Math.floor(G.z),Math.floor(G.x),[],!1)),0==K[0]&&0==K[1]&&(K=D.findRamp(H,I,J,0)),null!=K&&0==K[0]&&0==K[1]&&(K=D.findRamp(H,I,J,-1)),K},D.shortGoal=[null,null,null,null,null,null];let E=0;return D.update=(F,G)=>{const H=Math.min(F-E,160)/1e3;E=F,0==D.hitTime&&(D.hitTime=F);const I=Math.floor(D.l.y),J=Math.floor(D.l.z),K=Math.floor(D.l.x);if(null==D.shortGoal[0]){var L=D.getGoal(F,G,I,J,K);null!=L&&(D.shortGoal[0]=L[0],D.shortGoal[1]=L[1],D.shortGoal[3]=K+.5*D.shortGoal[1],D.shortGoal[2]=J+.5*D.shortGoal[0])}if(D.l.x+=D.shortGoal[1]*H*D.speedMult,D.l.z+=D.shortGoal[0]*H*D.speedMult,null!=D.shortGoal[4]){var M=(3-Math.abs(D.shortGoal[2]-D.l.z))/2.9,N=(3-Math.abs(D.shortGoal[3]-D.l.x))/2.9,O=D.shortGoal[5]>D.shortGoal[4];O&&D.l.y>=D.shortGoal[5]||!O&&D.l.y<=D.shortGoal[5]||0>M||0>N?(D.shortGoal[4]=D.shortGoal[5]=null,D.l.y=Math.floor(D.l.y)+.5):O?D.l.y=D.shortGoal[4]+2*Math.abs(D.shortGoal[0])*M+2*Math.abs(D.shortGoal[1])*N:D.l.y=D.shortGoal[4]-2*Math.abs(D.shortGoal[0])*M-2*Math.abs(D.shortGoal[1])*N}(0<D.shortGoal[1]&&D.l.x>D.shortGoal[3]||0>D.shortGoal[1]&&D.l.x<D.shortGoal[3]||0<D.shortGoal[0]&&D.l.z>D.shortGoal[2]||0>D.shortGoal[0]&&D.l.z<D.shortGoal[2]||0==D.shortGoal[1]&&0==D.shortGoal[0])&&(D.shortGoal[0]=D.shortGoal[1]=null)},D.explode=F=>{D.health=0,audio.playNote(440);const[G,H,I]=getIntCoords(D.l);F.push([G,H,I,5])},D};const createShader=(d,f,p)=>{const t=d.createShader(f);return d.shaderSource(t,p),d.compileShader(t),t},createProgram=(d,f,p)=>{const t=d.createProgram();return d.attachShader(t,f),d.attachShader(t,p),d.linkProgram(t),t},analyzeProgram=(d,f)=>{const p={program:f,_attributes:{},_uniforms:{}};return p.getAttribute=t=>{return p._attributes.hasOwnProperty(t)||(p._attributes[t]=d.getAttribLocation(f,`a_${t}`)),p._attributes[t]},p.getUniform=t=>{return p._uniforms.hasOwnProperty(t)||(p._uniforms[t]=d.getUniformLocation(f,`u_${t}`)),p._uniforms[t]},p},newProgram=(d,f)=>{const p=shaders[f].vertex,t=shaders[f].fragment,u=createShader(d,d.VERTEX_SHADER,p),D=createShader(d,d.FRAGMENT_SHADER,t),E=createProgram(d,u,D);return analyzeProgram(d,E)},uploadBuffer=(d,f)=>{const p=d.createBuffer();return d.bindBuffer(d.ARRAY_BUFFER,p),d.bufferData(d.ARRAY_BUFFER,new Float32Array(f),d.STATIC_DRAW),p},ut=(d,f)=>{const p=d.createTexture();return d.bindTexture(d.TEXTURE_2D,p),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,d.RGB,d.RGB,d.UNSIGNED_BYTE,f),p},createRenderer=(d,f)=>{const p={uniform:{sampler2D:{},float:{},vec3:{},mat4:{}},attribute:{float:{},vec2:{},vec3:{}}};return{data:p,render:u=>{d.useProgram(f.program);let D=0;Object.getOwnPropertyNames(p.uniform.sampler2D).forEach(E=>{const F=p.uniform.sampler2D[E],G=f.getUniform(E);d.activeTexture(d.TEXTURE0+D),d.bindTexture(d.TEXTURE_2D,F),d.uniform1i(G,D),D++}),Object.getOwnPropertyNames(p.uniform.float).forEach(E=>{const F=p.uniform.float[E],G=f.getUniform(E);d.uniform1f(G,F)}),Object.getOwnPropertyNames(p.uniform.vec3).forEach(E=>{const F=p.uniform.vec3[E],G=f.getUniform(E);d.uniform3fv(G,new Float32Array(F))}),Object.getOwnPropertyNames(p.uniform.mat4).forEach(E=>{const F=p.uniform.mat4[E],G=f.getUniform(E);d.uniformMatrix4fv(G,!1,new Float32Array(F))}),Object.getOwnPropertyNames(p.attribute.float).forEach(E=>{const F=p.attribute.float[E],G=f.getAttribute(E);d.enableVertexAttribArray(G),d.bindBuffer(d.ARRAY_BUFFER,F),d.vertexAttribPointer(G,1,d.FLOAT,!1,0,0)}),Object.getOwnPropertyNames(p.attribute.vec2).forEach(E=>{const F=p.attribute.vec2[E],G=f.getAttribute(E);d.enableVertexAttribArray(G),d.bindBuffer(d.ARRAY_BUFFER,F),d.vertexAttribPointer(G,2,d.FLOAT,!1,0,0)}),Object.getOwnPropertyNames(p.attribute.vec3).forEach(E=>{const F=p.attribute.vec3[E],G=f.getAttribute(E);d.enableVertexAttribArray(G),d.bindBuffer(d.ARRAY_BUFFER,F),d.vertexAttribPointer(G,3,d.FLOAT,!1,0,0)}),d.drawArrays(d.TRIANGLES,0,u)}}},renderToTexture=(d,f,p,t)=>{const u=d.createTexture(),D=d.createFramebuffer();return d.bindTexture(d.TEXTURE_2D,u),d.texImage2D(d.TEXTURE_2D,0,d.RGB,f,p,0,d.RGB,d.UNSIGNED_BYTE,null),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.bindFramebuffer(d.FRAMEBUFFER,D),d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,u,0),d.bindFramebuffer(d.FRAMEBUFFER,D),d.viewport(0,0,f,p),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),d.disable(d.CULL_FACE),t(),d.enable(d.CULL_FACE),d.bindFramebuffer(d.FRAMEBUFFER,null),d.deleteFramebuffer(D),u};const mm=(d,f)=>{const p=[];for(let t=0;4>t;t++)for(let D,u=0;4>u;u++){D=0;for(let E=0;4>E;E++)D+=d[4*E+u]*f[4*t+E];p.push(D)}return p},identity=()=>{return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},scale=(d,f,p)=>{return[d,0,0,0,0,f,0,0,0,0,p,0,0,0,0,1]},tr=(d,f,p)=>{return[1,0,0,0,0,1,0,0,0,0,1,0,d,f,p,1]},rotate={x:d=>{const f=Math.cos(d),p=Math.sin(d);return[1,0,0,0,0,f,-p,0,0,p,f,0,0,0,0,1]},y:d=>{const f=Math.cos(d),p=Math.sin(d);return[f,0,-p,0,0,1,0,0,p,0,f,0,0,0,0,1]},z:d=>{const f=Math.cos(d),p=Math.sin(d);return[f,-p,0,0,p,f,0,0,0,0,1,0,0,0,0,1]}},perspective=(d,f)=>{const p=1<d?1:1/d,t=1<d?d:1,u=1/Math.tan(f/2);return[p*u,0,0,0,0,t*u,0,0,0,0,0.1,1,0,0,0,1]};const m={start_position:{x:1.5,y:1.5,z:1.5},height:9,width:9,layers:0,rampsPerLayer:2,start_direction:1*Math.PI,b:[],blockInfo:[]},findFirstChoice=(d,f)=>{for(var p=[[0,0]];null!=f[d][0];)p.push(f[d][1]),d=f[d][0];return p[p.length-1]},bfs=(d,f,p,t,u,D,E)=>{var F=[],G=[],H={},I=f+'|'+p;H[I]=[null,null],(f!=t||p!=u)&&F.push(I);for(var J=[[-1,0],[1,0],[0,-1],[0,1]];0<F.length;){var K=F.shift(),L=K.indexOf('|');if(f=parseInt(K.substring(0,L)),p=parseInt(K.substring(L+1)),0>=d||d>=m.b.length||0>=f||f>=m.b[d].length||0>=p||p>=m.b[d][f].length){G.push(K);continue}if(D.includes(m.b[d][f][p]))return[d,f,p];if(f==t&&p==u)return findFirstChoice(K,H);if(!E&&0!=m.b[d][f][p]){G.push(K);continue}var M=getCollisions(m.b,d,f,p);J.forEach((N,O)=>{var P=f+N[0]+'|'+(p+N[1]);G.includes(P)||F.includes(P)||!E&&M[O]&&!D.includes(m.b[d][f+N[0]][p+N[1]])||(H[P]=[K,N],F.push(P))}),G.push(K)}return[0,0]},findRampFoot=(d,f,p,t)=>{var f=m.b[d][f][p],u=0,D=0;return 6==f?(u=0==t?-1:1,D=0):7==f?(u=0,D=0==t?1:-1):8==f?(u=0==t?1:-1,D=0):9==f&&(u=0,D=0==t?-1:1),[u,D]},pt={none:0,ammo:1,health:2,exit:3},randomEmptyZX=d=>{for(var p=0,t=0,u=Math.floor(d);0!=m.b[u][Math.floor(t)][Math.floor(p)];)t=Math.floor(Math.random()*(m.b[u].length-2))+1.5,p=Math.floor(Math.random()*(m.b[u][0].length-2))+1.5;return[t,p]};m.init=d=>{function f(){var R=1e4*Math.sin(p++);return R-Math.floor(R)}m.b=[],m.blockInfo=[];var p=d;const t=(R,S)=>{return Math.floor(f()*(S-R))+R},u=(R,S,T,U,V)=>{T*=5*(S+R),U*=Math.floor(S/2)*Math.floor(R/2);let W=[];for(let X=0;X<S;X++){W.push([]);for(let Y=0;Y<R;Y++)0==X||0==Y||X==S-1||Y==R-1?W[X].push(V):W[X].push(0)}for(let X=0;X<U;X++){let Y=2*t(0,Math.floor(R/2)),$=2*t(0,Math.floor(S/2));W[$][Y]=V;for(let aa,_=0;_<T;_++)if(aa=[],1<Y&&aa.push([$,Y-2]),Y<R-2&&aa.push([$,Y+2]),1<$&&aa.push([$-2,Y]),$<S-2&&aa.push([$+2,Y]),0<aa.length){let ba=t(0,aa.length-1),da=aa[ba][0],ea=aa[ba][1];0==W[da][ea]&&(W[da][ea]=V,W[da+Math.floor(($-da)/2)][ea+Math.floor((Y-ea)/2)]=V,Y=ea,$=da)}}return W},D=(R,S,T)=>{let U=[];for(let V=0;V<S;V++){U.push([]);for(let W=0;W<R;W++)U[V].push(T)}return U},E=[2,3,4],F=(R,S,T,U,V,W,X,Y,$,_,aa,ba,da,ea,fa,ga,ha,ia)=>{return E.includes(m.b[R][S][T])&&(W&&U>V||!W&&U<V)&&0==m.b[R][X][Y]&&(aa&&$>_||!aa&&$<_)&&E.includes(m.b[R+1][ea][fa])&&0==m.b[R+2][ba][da]&&0==m.b[R+2][ea][fa]&&ga<ha&&(m.b[R][S][T]=ia,m.b[R+1][S][T]=0,m.b[R+1][ba][da]=ia,!0)},G=R=>{let S=0;for(let T=0;T<m.height;T++)for(let V,U=0;U<m.width;U++)V=f(),(S<m.rampsPerLayer&&F(R,T,U,T-1,1,!0,T-1,U,T+2,m.height-1,!1,T+1,U,T+2,U,V,.1,6)||F(R,T,U,T+1,m.height-1,!1,T+1,U,T-2,1,!0,T-1,U,T-2,U,V,.2,8)||F(R,T,U,U-1,1,!0,T,U-1,U+2,m.width-1,!1,T,U+1,T,U+2,V,.3,9)||F(R,T,U,U+1,m.width-1,!1,T,U+1,U-2,1,!0,T,U-1,T,U-2,V,.4,7))&&S++};for(let R=0;R<m.layers+1;R++)m.b.push(D(m.width,m.height,0==R?2:3)),m.b.push(u(m.width,m.height,0.1,0.15,4));m.b.push(D(m.width,m.height,1));for(let R=1;R<2*m.layers+1;R+=2)G(R);m.b[1][0][1]=5,m.b[m.b.length-2][m.height-2][m.width-2]=-1;let H=1,I=1;for(let R=1;R<2*m.layers+2;R+=2){var L=bfs(R,I,H,null,null,[6,7,8,9,-1],!1,1),M=[0,0];if(3==L.length){var N=m.b[L[0]][L[1]][L[2]];if(-1==N)break;var O=findRampFoot(L[0],L[1],L[2],0);M=bfs(R,I,H,L[1]+O[0],L[2]+O[1],[],!1,1)}for(;0==M[0]&&0==M[1];)if(m.b[R]=u(m.width,m.height,0.1,0.15,4),G(R),L=bfs(R,I,H,null,null,[6,7,8,9,-1],!1,1),3==L.length){if(N=m.b[L[0]][L[1]][L[2]],-1==N)break;O=findRampFoot(L[0],L[1],L[2],0),M=bfs(R,I,H,L[1]+O[0],L[2]+O[1],[],!1,1)}if(-1==N)break;I=L[1]+-2*O[0],H=L[2]+-2*O[1]}m.b[1][0][1]=5,m.b[m.b.length-2][m.height-2][m.width-2]=0,m.b[m.b.length-2][m.height-1][m.width-2]=10;const P=[6,7,8,9];for(let S,R=1;R<2*m.layers+1;R+=2){S=0;for(let T=0;T<m.height;T++)for(let U=0;U<m.width;U++)0==m.b[R][T][U]&&0==m.b[R+2][T][U]&&E.includes(m.b[R+1][T][U])&&1<T&&0==m.b[R+2][T-1][U]&&!P.includes(m.b[R+1][T-1][U])&&T<m.height-1&&0==m.b[R+2][T+1][U]&&!P.includes(m.b[R+1][T+1][U])&&1<U&&0==m.b[R+2][T][U-1]&&!P.includes(m.b[R+1][T][U-1])&&U<m.width-1&&0==m.b[R+2][T][U+1]&&!P.includes(m.b[R+1][T][U+1])&&(m.b[R+1][T][U]=0)}let Q=0;for(let R=0;R<m.b.length;R++){const S=[];for(let T=0;T<m.b[0].length;T++){const U=[];for(let V=0;V<m.b[0][0].length;V++)U.push({attributeBufferIndex:Q++,powerup:pt.none});S.push(U)}if(m.blockInfo.push(S),1==R%2){var M=randomEmptyZX(R);m.blockInfo[R][Math.floor(M[0])][Math.floor(M[1])].powerup=pt.ammo,M=randomEmptyZX(R),m.blockInfo[R][Math.floor(M[0])][Math.floor(M[1])].powerup=pt.health}}m.blockInfo[m.b.length-2][m.height-2][m.width-2].powerup=pt.exit};const createEmitter=(d,f)=>{const p=2*-Math.PI/3,t=L=>[0.5*Math.sin(p*L),0.5*Math.cos(p*L),0],u=[],D=[],E=(L,M)=>M.forEach(N=>L.push(N));for(let L=0;50>L;L++){E(u,flatten([t(0),t(1),t(2)]));const M=Math.random();E(D,[M,M,M])}const F=newProgram(d,'particle'),G=uploadBuffer(d,u),H=uploadBuffer(d,D),I=createRenderer(d,F);I.data.uniform.sampler2D.palette=f,I.data.uniform.float.filter=1,I.data.attribute.vec3.position=G,I.data.attribute.float.entropy=H;const J=u.length/3;return{renderer:I,render:()=>{I.render(J)}}},spawnEmitter=(d,f,p,t,u)=>{let D=identity();D=mm(D,tr(f,p,t)),D=mm(D,scale(1/8,1/8,1/8));const E={age:0},F=Math.random();return{render:(H,I,J)=>{const K=[J.s.player.l.x-f,J.s.player.l.y-p,J.s.player.l.z-t];d.renderer.data.uniform.mat4.transform=mm(H,D),d.renderer.data.uniform.vec3.delta=K,d.renderer.data.uniform.float.age=E.age,d.renderer.data.uniform.float.size=u,d.renderer.data.uniform.float.nonce=F,d.render()},s:E}};const flatten=d=>{const f=[];return d.forEach(p=>{p.forEach(t=>{f.push(t)})}),f},newQuad=(d,f,p,t,u)=>{const D=newProgram(d,'quad'),E=1,F=[-E,-E,E,-E,E,E,-E,-E,E,E,-E,E],H=uploadBuffer(d,F),I=uploadBuffer(d,[0,1,1,1,1,0,0,1,1,0,0,0]);let J=identity();J=mm(J,tr(t/u,0,0)),J=mm(J,scale(1/u,1,1));const K=createRenderer(d,D);K.data.uniform.sampler2D.image=p,K.data.uniform.sampler2D.palette=f,K.data.uniform.float.filter=1,K.data.uniform.mat4.texTransform=J,K.data.attribute.vec2.position=H,K.data.attribute.vec2.texCoord=I;const L=F.length/2;return(M,N)=>{K.data.uniform.mat4.transform=N,K.render(L)}},addBlockToMesh=(d,f,p,t,u)=>{var D=u||1;const E=[f+D,p+D,t],F=[f+D,p+D,t+D],G=[f+D,p,t],H=[f+D,p,t+D],I=[f,p+D,t],J=[f,p+D,t+D],K=[f,p,t],L=[f,p,t+D];flatten([K,E,I,K,G,E,G,F,E,G,H,F,H,J,F,H,L,J,L,I,J,L,K,I,I,F,J,I,E,F,L,G,K,L,H,G]).forEach(N=>d.vertices.push(N));const M=[0,1,1,0,0,0,0,1,1,1,1,0];flatten([M,M,M,M,M,M]).forEach(N=>d.texCoords.push(N))},addRampToMesh=(d,f,p,t,u)=>{const D=0.5,E=tr(D+p,D+t,D+u),F=rotate.y(-Math.PI/2*f),G=mm(E,F),H=(P,Q,R)=>mm(G,[P,Q,R,1]).splice(0,3),I=H(+D,+D,+D),J=H(+D,-D,-D),K=H(+D,-D,+D),L=H(-D,+D,+D),M=H(-D,-D,-D),N=H(-D,-D,+D);flatten([M,I,L,M,J,I,J,K,I,K,L,I,K,N,L,N,M,L,M,K,J,M,N,K]).forEach(P=>d.vertices.push(P));const O=[0,1,1,0,0,0,0,1,1,1,1,0];flatten([O,[0,1,1,1,1,0],O,[0,1,1,1,0,0],O]).forEach(P=>d.texCoords.push(P))},addPowerupToMesh=(d,f,p,t,u)=>{const D=0.5,E=[+D,+D,0],H=[-D,-D,0];flatten([H,E,[-D,+D,0],H,[+D,-D,0],E]).forEach(J=>d.vertices.push(J)),[0,1,1,0,0,0,0,1,1,1,1,0].forEach(J=>d.texCoords.push(J));const I=[f,p,t];flatten([I,I,I,I,I,I]).forEach(J=>d.positions.push(J)),[u,u,u,u,u,u].forEach(J=>d.types.push(J))},newMeshRenderer=(d,f)=>{const p=f.program,t=uploadBuffer(d,f.vertices),u=uploadBuffer(d,f.texCoords),D=createRenderer(d,p);D.data.uniform.sampler2D.image=f.texture,D.data.uniform.sampler2D.palette=f.palette,D.data.uniform.float.filter=1,D.data.attribute.vec3.position=t,D.data.attribute.vec2.texCoord=u;const E=f.vertices.length/3;return F=>{D.data.uniform.mat4.transform=F,D.render(E)}},newPowerupRenderer=(d,f)=>{const p=f.program,t=uploadBuffer(d,f.vertices),u=uploadBuffer(d,f.positions),D=uploadBuffer(d,f.texCoords),E=uploadBuffer(d,f.types),F=createRenderer(d,p);F.data.uniform.sampler2D.image=f.texture,F.data.uniform.sampler2D.palette=f.palette,F.data.uniform.float.filter=1,F.data.attribute.vec3.vtx_pos=t,F.data.attribute.vec3.mdl_pos=u,F.data.attribute.vec2.texCoord=D,F.data.attribute.float.type=E;const G=f.vertices.length/3;return{render:(I,J,K,L,M)=>{F.data.uniform.mat4.transform=I,F.data.uniform.vec3.player=[K,L,M],F.data.uniform.float.time=J,F.render(G)},typeBufferId:E,typeData:f.types,stale:!1}};const _u=`uniform`,_a=`attribute`,_vv=`varying vec`,_vf=`varying float `,_vm=`void main() {`,_sc=(d,f)=>`vec2 ${d}=vec2(sin(${f}),cos(${f}));`,_f=`
float n=3.0;vec3 xyz=floor(rgb*(n-0.001));float idx=(xyz.x*n*n+xyz.y*n+xyz.z+0.5)/(n*n*n);vec3 rgb2=texture2D(u_palette,vec2(idx,0.5)).rgb;gl_FragColor=vec4(rgb2*u_filter+(1.0-u_filter)*rgb,1);`,_g=`
precision mediump float;${_u} sampler2D u_palette;${_u} sampler2D u_image;${_u} float u_filter;`,shaders={block:{vertex:`
${_u} mat4 u_transform;${_a} vec3 a_position;${_a} vec2 a_texCoord;${_vv}3 qa;${_vv}2 qb;
${_vm}
qa=(u_transform*vec4(a_position,1)).xyz;qb=a_texCoord;gl_Position=u_transform*vec4(a_position,1);}`,fragment:`
${_g}
${_vv}3 qa;${_vv}2 qb;
${_vm}
vec3 rgb=texture2D(u_image,qb).rgb;rgb *= 1.0-0.75*min(max(0.0,qa.z),1.0);${_f}
}`},quad:{vertex:`
${_u} mat4 u_transform;${_a} vec2 a_position;${_a} vec2 a_texCoord;${_vv}2 qb;
${_vm}
qb=a_texCoord;gl_Position=u_transform*vec4(a_position,0,1);}`,fragment:`
${_g}
${_u} mat4 u_texTransform;${_vv}2 qb;
${_vm}
vec4 tc=u_texTransform*vec4(qb,0,1);vec3 rgb=texture2D(u_image,tc.xy).rgb;${_f}
}`},particle:{vertex:`
${_u} mat4 u_transform;${_u} vec3 u_delta;${_u} float u_age;${_u} float u_size;${_u} float u_nonce;${_a} vec3 a_position;${_a} float a_entropy;${_vf}qc;
${_vm}
float qo=fract(a_entropy+u_nonce);qc=qo;float qp=(0.5*qo+0.5)*6.0*pow(u_age,0.5);float qf=u_age*6.28*4.0*(qo-0.5);float qn=-atan(u_delta.z,u_delta.x);float qg=-atan(-length(u_delta.xz),u_delta.y);float qh=6.28*fract(qo*256.0);float qi=3.14*fract(qo*65535.0);${_sc('sc','qf')}${_sc('ab','qn')}${_sc('fg','qg')}${_sc('st','qh')}${_sc('uv','qi')}mat4 qm=mat4(
1,0,0,0,0,fg.x,fg.y,0,0,-fg.y,fg.x,0,0,0,0,1
);mat4 qk=mat4(
ab.x,0,ab.y,0,0,1,0,0,-ab.y,0,ab.x,0,0,0,0,1
);mat4 ql=mat4(
sc.x,sc.y,0,0,-sc.y,sc.x,0,0,0,0,1,0,0,0,0,1
);float invAge=u_size/(1.0+u_age*u_age*9.0);mat4 scale=mat4(
invAge,0,0,0,0,invAge,0,0,0,0,invAge,0,0,0,0,1
);vec4 abc=vec4(st.x*uv.x,st.y*uv.x,uv.y,0);vec4 pos=scale*qk*qm*ql*vec4(a_position,1)+qp*abc;pos.y-=pow(u_age*1.25,2.0);gl_Position=u_transform*pos;}`,fragment:`
${_g}
${_vf}qc;
${_vm}
vec3 rgb=vec3(fract(qc*16.0),fract(qc*256.0),fract(qc*4096.0));rgb.g *= rgb.r;rgb.b *= rgb.g;${_f}
}`},powerup:{vertex:`
${_u} mat4 u_transform;${_u} vec3 u_player;${_u} float u_time;${_a} vec3 a_vtx_pos;${_a} vec3 a_mdl_pos;${_a} vec2 a_texCoord;${_a} float a_type;${_vv}3 qa;${_vv}2 qb;${_vf}qd;${_vf}qe;
${_vm}
vec3 mdl=a_mdl_pos;mdl.xz+=0.5;mdl.y+=0.2;mdl.y+=0.05*sin(u_time*3.14);vec3 delta=u_player-mdl;float a1=-atan(delta.z,delta.x);float a2=-atan(-length(delta.xz),delta.y);float a3=0.0;if (a_type==3.0) {
a3=u_time*10.0;}
${_sc('ab','a1')}${_sc('fg','a2')}${_sc('sc','a3')}mat4 rx=mat4(
1,0,0,0,0,fg.x,fg.y,0,0,-fg.y,fg.x,0,0,0,0,1
);mat4 ry=mat4(
ab.x,0,ab.y,0,0,1,0,0,-ab.y,0,ab.x,0,0,0,0,1
);mat4 rz=mat4(
sc.x,sc.y,0,0,-sc.y,sc.x,0,0,0,0,1,0,0,0,0,1
);float s=0.2;mat4 scale=mat4(s,0,0,0,0,s,0,0,0,0,s,0,0,0,0,1);vec4 pos=scale*ry*rx*rz*vec4(a_vtx_pos,1)+vec4(mdl,0);vec4 tpos=u_transform*pos;tpos.xyz *= min(a_type,1.0);vec2 tex=a_texCoord;tex.x=(tex.x+a_type-1.0)/3.0;qa=tpos.xyz;qb=tex;qd=u_time;qe=a_type;gl_Position=tpos;}`,fragment:`
${_g}
${_vv}3 qa;${_vv}2 qb;${_vf}qd;${_vf}qe;
${_vm}
vec3 rgb=texture2D(u_image,qb).rgb;if (qe==3.0) {
rgb.r=0.75+0.25*sin(qd*5.0);rgb.g=0.75+0.25*sin(qd*7.0);rgb.b=0.75+0.25*sin(qd*11.0);}
rgb *= 1.0-0.75*min(max(0.0,qa.z),1.0);${_f}
}`}};const byte=d=>{return Math.floor(255*d)},getRgb2=(d,f,p)=>{return[byte(d),byte(f),byte(p)]},randomTexture=(d,f,p,t)=>{const u=document.createElement('canvas').getContext('2d');u.canvas.width=d,u.canvas.height=d;for(let D=0;D<d;D++)for(let E=0;E<d;E++){const F=Math.random(),G=getRgb2(F*f,F*p,F*t);u.fillStyle=`rgb(${G[0]}, ${G[1]}, ${G[2]})`,u.fillRect(D,E,1,1)}return u.canvas},solidTexture=(d,f,p)=>{const t=document.createElement('canvas').getContext('2d');t.canvas.width=1,t.canvas.height=1;const u=getRgb2(d,f,p);return t.fillStyle=`rgb(${u[0]}, ${u[1]}, ${u[2]})`,t.fillRect(0,0,1,1),t.canvas},solidTextureStack=(...d)=>{const f=document.createElement('canvas').getContext('2d');f.canvas.width=d.length,f.canvas.height=1;for(let p=0;p<d.length;p++){const t=getRgb2(...d[p]);f.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,f.fillRect(p,0,1,1)}return f.canvas},paletteTexture=()=>{const d=document.createElement('canvas').getContext('2d'),f=3,p=f-1;d.canvas.width=f*f*f,d.canvas.height=1;for(let t=0;t<f;t++)for(let u=0;u<f;u++)for(let D=0;D<f;D++){const E=getRgb2(t/p,u/p,D/p);d.fillStyle=`rgb(${E[0]}, ${E[1]}, ${E[2]})`;let F=t*f*f+u*f+D;d.fillRect(F,0,1,1)}return d.canvas};